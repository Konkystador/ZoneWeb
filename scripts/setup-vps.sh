#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VPS –¥–ª—è ZoneWeb –ø—Ä–æ–µ–∫—Ç–∞
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: bash setup-vps.sh

set -e

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS –¥–ª—è ZoneWeb..."

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
sudo apt install -y curl wget git nginx certbot python3-certbot-nginx

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 18
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js..."
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
echo "‚ö° –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
sudo npm install -g pm2

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
sudo mkdir -p /var/www/ZoneWeb
sudo chown -R $USER:$USER /var/www/ZoneWeb

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
cd /var/www/ZoneWeb
git clone https://github.com/Konkystador/ZoneWeb.git .

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
if [ -f package.json ]; then
    npm install
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
sudo tee /etc/nginx/sites-available/zoneweb << EOF
server {
    listen 80;
    server_name your-domain.com;  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
    
    root /var/www/ZoneWeb;
    index index.html index.htm;
    
    location / {
        try_files \$uri \$uri/ /index.html;
    }
    
    # –î–ª—è API (–µ—Å–ª–∏ –±—É–¥–µ—Ç)
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞
sudo ln -sf /etc/nginx/sites-available/zoneweb /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..."
echo "–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "sudo certbot --nginx -d your-domain.com"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PM2 –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
echo "‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PM2..."
pm2 startup
pm2 save

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ó–∞–º–µ–Ω–∏—Ç–µ 'your-domain.com' –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –∑–∞–ø–∏—Å–∏"
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL: sudo certbot --nginx -d your-domain.com"
echo "4. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub Actions"
